<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Data Competition">
    <meta name="keywords"  content="lambda">
    <meta name="theme-color" content="#000000">
    
    <title>2019-08-22-Data-competition-From-0-to-1-Part-II - lambda 的博客 | Lambda Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Safari Webpage Icon    by-BY -->
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://lambda-xmu.github.io/2018/08/22/Data-competition-From-0-to-1-Part-II/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script type="text/x-mathjax-config"> 
   		MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); 
   	</script>
    <script type="text/x-mathjax-config">
    	MathJax.Hub.Config({tex2jax: {
             inlineMath: [ ['$','$'], ["\\(","\\)"] ],
             processEscapes: true
           }
         });
    </script>
    
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
    </script>
    
    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">lambda</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-2015.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-2015.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Data Competition" title="Data Competition">Data Competition</a>
                        
                        <a class="tag" href="/tags/#Feature Engineering" title="Feature Engineering">Feature Engineering</a>
                        
                        <a class="tag" href="/tags/#Processing" title="Processing">Processing</a>
                        
                    </div>
                    <h1>2019-08-22-Data-competition-From-0-to-1-Part-II</h1>
                    
                    
                    <h2 class="subheading">Feature Engineering Techniques</h2>
                    
                    <span class="meta">Posted by lambda on August 22, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<p>Concat: <a href="https://github.com/lambda-xmu">github: lambda_xmu</a></p>

<h2 id="introduction">Introduction</h2>

<p>Feature engineering, the process creating new input features for machine learning, is one of the most effective ways to improve predictive models.</p>

<blockquote>
  <p>“Coming up with features is difficult, time-consuming, requires expert knowledge. “Applied machine learning” is basically feature engineering.”    – Andrew Ng</p>
</blockquote>

<blockquote>
  <p>“… some machine learning projects succeed and some fail. What makes the difference? Easily the most important factor is the features used.”   – Pedro Domingos</p>
</blockquote>

<h3 id="what-is-feature-engineering">What is Feature Engineering?</h3>
<p>We define feature engineering as creating new features from your existing ones to improve model performance.</p>

<p><strong>Typical Enterprise Machine Learning Workflow</strong>
<img src="http://lambda-xmu.github.io/img/Machine_Learning_Workflow.png" alt="" /></p>

<h3 id="what-is-not-feature-engineering">What is Not Feature Engineering?</h3>
<p>That means there are certain steps we do not consider to be feature engineering:</p>
<ul>
  <li>We do not consider <strong>initial data collection</strong> to be feature engineering.</li>
  <li>Similarly, we do not consider <strong>creating the target variable</strong> to be feature engineering.</li>
  <li>We do not consider removing duplicates, handling missing values, or fixing mislabeled classes to be feature engineering. We put these under <strong>data cleaning</strong>.</li>
  <li>We do not consider <strong>scaling or normalization</strong> to be feature engineering because these steps belong inside the cross-validation loop.</li>
  <li>Finally, we do not consider <strong>feature selection or PCA</strong> to be feature engineering. These steps also belong inside your cross-validation loop.</li>
</ul>

<h3 id="feature-engineering-cycle">Feature Engineering cycle</h3>
<p><img src="http://lambda-xmu.github.io/img/Feature_Engineering_cycle.png" alt="" /></p>

<ul>
  <li>Hypothesis
    <ul>
      <li>Domain knowledge</li>
      <li>Prior experience</li>
      <li>EDA</li>
      <li>ML model feedback</li>
    </ul>
  </li>
  <li>Validate hypothesis
    <ul>
      <li>Cross-validation</li>
      <li>Measurement of desired metrics</li>
      <li>Avoid leakage</li>
    </ul>
  </li>
</ul>

<h2 id="processing">Processing</h2>
<h3 id="imputation">Imputation</h3>
<p>Missing values are one of the most common problems you can encounter when you try to prepare your data for machine learning.</p>

<p>The most simple solution to the missing values is to drop the rows or the entire column. There is not an optimum threshold for dropping but you can use 70% as an example value and try to drop the rows and columns which have missing values with higher than this threshold.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="c">#Dropping columns with missing value rate higher than threshold</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]]</span>

<span class="c">#Dropping rows with missing value rate higher than threshold</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="numerical-imputation">Numerical Imputation</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Filling all missing values with 0</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c">#Filling missing values with medians of the columns</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
</code></pre></div></div>

<h4 id="categorical-imputation">Categorical Imputation</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Max fill function for categorical columns</span>
<span class="n">data</span><span class="p">[</span><span class="s">'column_name'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'column_name'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c"># or</span>
<span class="n">data</span><span class="p">[</span><span class="s">'column_name'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'Other'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="handling-outliers">Handling Outliers</h3>
<p><strong>Best way to detect the outliers is to demonstrate the data visually.</strong> All other statistical methodologies are open to making mistakes, whereas visualizing the outliers gives a chance to take a decision with high precision.</p>

<h4 id="outlier-detection-with-standard-deviation">Outlier Detection with Standard Deviation</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Dropping the outlier rows with standard deviation</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">upper_lim</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">factor</span>
<span class="n">lower_lim</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">factor</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">upper_lim</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lower_lim</span><span class="p">)]</span>
</code></pre></div></div>

<h4 id="outlier-detection-with-percentiles">Outlier Detection with Percentiles</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Dropping the outlier rows with Percentiles</span>
<span class="n">upper_lim</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="o">.</span><span class="mi">95</span><span class="p">)</span>
<span class="n">lower_lim</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="o">.</span><span class="mo">05</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">upper_lim</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lower_lim</span><span class="p">)]</span>

<span class="c">#Capping the outlier rows with Percentiles</span>
<span class="n">upper_lim</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="o">.</span><span class="mi">95</span><span class="p">)</span>
<span class="n">lower_lim</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="o">.</span><span class="mo">05</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper_lim</span><span class="p">),</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_lim</span>
<span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower_lim</span><span class="p">),</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_lim</span>
</code></pre></div></div>

<h3 id="log-transform">Log Transform</h3>
<p>The benefits of log transform:</p>
<ul>
  <li>It helps to handle skewed data and after transformation, the distribution becomes more approximate to normal.</li>
  <li>It also decreases the effect of the outliers, due to the normalization of magnitude differences and the model become more robust.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Negative Values Handling</span>
<span class="n">data</span><span class="p">[</span><span class="s">'log'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s">'value'</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="feature-engineering-techniques">Feature Engineering Techniques</h2>
<h3 id="indicator-variables">Indicator Variables</h3>
<p>The first type of feature engineering involves using indicator variables to isolate key information.</p>
<ul>
  <li><strong>Indicator variable from thresholds</strong>: create an indicator variable for <code class="highlighter-rouge">age &gt;= 18</code> to distinguish subjects who were the adult.</li>
  <li><strong>Indicator variable from multiple features</strong>: You’re predicting real-estate prices and you have the features <code class="highlighter-rouge">n_bedrooms</code> and <code class="highlighter-rouge">n_bathrooms</code>. If houses with 2 beds and 2 baths command a premium as rental properties, you can create an indicator variable to flag them.</li>
  <li><strong>Indicator variable for special events</strong>: You’re modeling weekly sales for an e-commerce site. You can create two indicator variables for the weeks of <code class="highlighter-rouge">11-11</code> and <code class="highlighter-rouge">6-18</code>.</li>
  <li><strong>Indicator variable for groups of classes</strong>: You’re analyzing APP conversions and your dataset has the categorical feature traffic_source. You could create an indicator variable for paid_traffic by flagging observations with traffic source values of <code class="highlighter-rouge">HUAWEI</code> or <code class="highlighter-rouge">XIAOMI</code>.</li>
</ul>

<h3 id="interaction-features">Interaction Features</h3>
<p>This type of feature engineering involves highlighting interactions between two or more features. Well, some features can be combined to provide more information than they would as individuals. Do you know <code class="highlighter-rouge">gender * father's height</code> and <code class="highlighter-rouge">gender * mather's height</code> in first homework?</p>

<p><strong>Note: We don’t recommend using an automated loop to create interactions for all your features. This leads to <code class="highlighter-rouge">feature explosion</code>.</strong></p>
<ul>
  <li><strong>Sum of two features</strong></li>
  <li><strong>Difference between two features</strong></li>
  <li><strong>Product of two features</strong></li>
  <li><strong>Quotient of two features</strong></li>
</ul>

<h3 id="feature-representation">Feature Representation</h3>
<p>Your data won’t always come in the ideal format. You should consider if you’d gain information by representing the same feature in a different way.</p>
<ul>
  <li><strong>Date and time features</strong>: Let’s say you have the feature <code class="highlighter-rouge">purchase_datetime</code>. It might be more useful to extract <code class="highlighter-rouge">purchase_day_of_week</code> and <code class="highlighter-rouge">purchase_hour_of_day</code>. You can also aggregate observations to create features such as <code class="highlighter-rouge">purchases_over_last_7_days</code>, <code class="highlighter-rouge">purchases_over_last_14_days</code>, <code class="highlighter-rouge">purchases_day_std</code>, <code class="highlighter-rouge">purchases_week_mean</code> etc.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">'date'</span><span class="p">:</span>
<span class="p">[</span><span class="s">'01-01-2017'</span><span class="p">,</span>
<span class="s">'04-12-2008'</span><span class="p">,</span>
<span class="s">'23-06-1988'</span><span class="p">,</span>
<span class="s">'25-08-1999'</span><span class="p">,</span>
<span class="s">'20-02-1993'</span><span class="p">,</span>
<span class="p">]})</span>

<span class="c"># Transform string to date</span>
<span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">"</span><span class="si">%</span><span class="s">d-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">Y"</span><span class="p">)</span>

<span class="c"># Extracting Year</span>
<span class="n">data</span><span class="p">[</span><span class="s">'year'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>

<span class="c"># Extracting Month</span>
<span class="n">data</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

<span class="c"># Extracting passed years since the date</span>
<span class="n">data</span><span class="p">[</span><span class="s">'passed_years'</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>

<span class="c"># Extracting passed months since the date</span>
<span class="n">data</span><span class="p">[</span><span class="s">'passed_months'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>

<span class="c"># Extracting the weekday name of the date</span>
<span class="n">data</span><span class="p">[</span><span class="s">'day_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>

</code></pre></div></div>

<ul>
  <li><strong>Binning (分箱)</strong>: Binning can be applied on both categorical and numerical data. When there is a feature with many classes that have low sample counts. You can try grouping similar classes and then grouping the remaining ones into a single <code class="highlighter-rouge">Other</code> class [<strong>Grouping sparse classes</strong>].</li>
</ul>

<p><img src="http://lambda-xmu.github.io/img/binning.png" alt="" /></p>

<p>The main motivation of binning is to make the model more robust and prevent overfitting, however, it has a cost to the performance. Every time you bin something, you sacrifice information and make your data more regularized.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Numerical Binning Example</span>
<span class="n">data</span><span class="p">[</span><span class="s">'bin'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'value'</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">100</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s">"Low"</span><span class="p">,</span> <span class="s">"Mid"</span><span class="p">,</span> <span class="s">"High"</span><span class="p">])</span>

<span class="c"># Categorical Binning Example</span>
<span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">data</span><span class="p">[</span><span class="s">'Country'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s">'Spain'</span><span class="p">),</span>
    <span class="n">data</span><span class="p">[</span><span class="s">'Country'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s">'Italy'</span><span class="p">),</span>
    <span class="n">data</span><span class="p">[</span><span class="s">'Country'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s">'Chile'</span><span class="p">),</span>
    <span class="n">data</span><span class="p">[</span><span class="s">'Country'</span><span class="p">]</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s">'Brazil'</span><span class="p">)]</span>

<span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Europe'</span><span class="p">,</span> <span class="s">'Europe'</span><span class="p">,</span> <span class="s">'South America'</span><span class="p">,</span> <span class="s">'South America'</span><span class="p">]</span>

<span class="n">data</span><span class="p">[</span><span class="s">'Continent'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'Other'</span><span class="p">)</span>  <span class="c"># Grouping sparse classes</span>
</code></pre></div></div>

<p><strong>For numerical columns, except for some obvious overfitting cases, binning might be redundant for some kind of algorithms, due to its effect on model performance. However, for categorical columns, the labels with low frequencies probably affect the robustness of statistical models negatively.</strong></p>

<ul>
  <li><strong>One-hot encoding</strong>: Transform categories into individual binary (0 or 1) features</li>
</ul>

<p><img src="http://lambda-xmu.github.io/img/one_hot.png" alt="" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">encoded_columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'column'</span><span class="p">])</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">encoded_columns</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'column'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<ul>
  <li>
    <p><strong>Labeled Encoding</strong>: Interpret the categories as ordered integers (mostly wrong)
<img src="http://lambda-xmu.github.io/img/label_encoding.png" alt="" /></p>
  </li>
  <li>
    <p><strong>Frequency Encoding</strong>: Encoding of categorical levels of feature to values between 0 and 1 based on their relative frequency.
<img src="http://lambda-xmu.github.io/img/frequency_encoding.png" alt="" /></p>
  </li>
  <li>
    <p><strong>Target mean encoding</strong>:
<img src="http://lambda-xmu.github.io/img/target_mean_encoding.png" alt="" /></p>
  </li>
</ul>

<h4 id="supplement">Supplement</h4>
<p><strong>Weighted Average</strong>
It is better to calculate weighted average of the overall mean of the training set and the mean of the level:</p>

<script type="math/tex; mode=display">\lambda(n) * \operatorname{mean}(\text {level})+(1-\lambda(n)) * \text {mean (dataset)}</script>

<p>Where $\lambda(n)=\frac{1}{1+\exp \left(\frac{-(x-k)}{f}\right)}$. $x = \text{frequency}, k = \text{inflection point}, f = \text{steepness}$. We can get graph in <a href="desmos.com/calculator">desmos_calculator</a>.</p>

<p><img src="http://lambda-xmu.github.io/img/target_encoding_weight.png" alt="" /></p>

<p><strong>To avoid overfitting we could use leave-one-out schema</strong>
<img src="http://lambda-xmu.github.io/img/leave_one_out.png" alt="" /></p>

<p><strong>Weight of Evidence</strong>
<script type="math/tex">W o E=\ln \left(\frac{\% \text { non - events }}{\% \text { events }}\right)</script></p>

<p>To avoid division by zero:</p>

<script type="math/tex; mode=display">\text { WoE }_{adj}=\ln \left(\frac{(\text { Number of non-events in a group }+0.5 )/ \text { Number of non-events }}{(\text { Number of events in a group }+0.5) / \text { Number of events }}\right)</script>

<p><strong>Information Value</strong>
<script type="math/tex">I V=\sum(\% \text { non - events }- \% \text { events }) * W o E</script>
<img src="http://lambda-xmu.github.io/img/WOE_IV.png" alt="" /></p>

<p>Information value is one of the most useful technique to select important variables in a predictive model.</p>
<ul>
  <li>Less than 0.02, then the predictor is not useful for modeling (separating the Goods from the Bads)</li>
  <li>0.02 to 0.1, then the predictor has only a weak relationship to the Goods/Bads odds ratio</li>
  <li>0.1 to 0.3, then the predictor has a medium strength relationship to the Goods/Bads odds ratio</li>
  <li>0.3 to 0.5, then the predictor has a strong relationship to the Goods/Bads odds ratio.</li>
  <li>0.5, suspicious relationship (Check once)</li>
</ul>

<p><strong>Information value increases as bins / groups increases for an independent variable. We have to be careful when there are more than 20 bins as some bins may have a very few number of events and non-events.</strong></p>

<h3 id="textual-data">Textual Data</h3>
<ul>
  <li>Bag-of-Words: extract tokens from text and use their occurrences (or TF/IDF weights) as features
    <ul>
      <li><code class="highlighter-rouge">CountVectorizer</code>, <code class="highlighter-rouge">TfidfTransformer</code></li>
    </ul>
  </li>
  <li>NLP techniques
    <ul>
      <li>Remove stop words (not always necessary)</li>
      <li>Convert all words to lower case</li>
      <li>Stemming for English words</li>
      <li>pingyin</li>
    </ul>
  </li>
  <li>Deep Learning for textual data
    <ul>
      <li>Turn each token into a vector of predefined size</li>
      <li>Help compute “semantic distance” between tokens/words</li>
    </ul>
  </li>
</ul>

<h3 id="external-data">External Data</h3>
<p>An underused type of feature engineering is bringing in external data. This can lead to some of the biggest breakthroughs in performance.</p>
<ul>
  <li><strong>External API’s</strong>: <code class="highlighter-rouge">BAIDU.DITU</code> etc</li>
  <li><strong>Geocoding</strong>: Let’s say you have <code class="highlighter-rouge">street_address</code>, <code class="highlighter-rouge">city</code>, and <code class="highlighter-rouge">state</code>. Well, you can geocode them into <code class="highlighter-rouge">latitude</code> and <code class="highlighter-rouge">longitude</code>. This will allow you to calculate features such as <code class="highlighter-rouge">local demographics</code>, <code class="highlighter-rouge">GDP</code> etc.</li>
  <li><strong>Other sources of the same data</strong></li>
</ul>

<h3 id="error-analysis-post-modeling">Error Analysis (Post-Modeling)</h3>
<p>The final type of feature engineering we’ll cover falls under a process called error analysis. This is performed after training your first model.</p>

<p>Error analysis is a broad term that refers to analyzing the misclassified or high error observations from your model and deciding on your next steps for improvement.</p>
<ul>
  <li><strong>Start with larger errors</strong></li>
  <li><strong>Segment by classes</strong></li>
  <li><strong>Unsupervised clustering</strong></li>
  <li><strong>Ask colleagues or domain experts</strong></li>
</ul>

<h2 id="conclusion">Conclusion</h2>
<p>Good features to engineer…</p>

<ul>
  <li>Can be computed for future observations.</li>
  <li>Are usually intuitive to explain.</li>
  <li>Are informed by domain knowledge or exploratory analysis.</li>
  <li>Must have the potential to be predictive. Don’t just create features for the sake of it.</li>
  <li><strong>Never touch the target variable</strong>.（穿越问题）</li>
</ul>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/08/20/Speed-Up-Python-Code/" data-toggle="tooltip" data-placement="top" title="2019-08-20-Speed-Up-Python-Code">
                        Previous<br>
                        <span>2019-08-20-Speed-Up-Python-Code</span>
                        </a>
                    </li>
                    
                    
                </ul>


                <!--Gitalk评论start  -->
                
                <!-- 引入Gitalk评论插件  -->
                <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
                <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
                <div id="gitalk-container"></div>
                <!-- 引入一个生产md5的js，用于对id值进行处理，防止其过长 -->
                <!-- Thank DF:https://github.com/NSDingFan/NSDingFan.github.io/issues/3#issuecomment-407496538 -->
                <script src="/js/md5.min.js"></script>
                <script type="text/javascript">
                    var gitalk = new Gitalk({
                    clientID: 'b20f94fc4df8d27e0ca5',
                    clientSecret: '621774eb54b29c82b5f0f2d97f4b81245c009c4b',
                    repo: 'lambda-xmu.github.io',
                    owner: 'lambda-xmu',
                    admin: ['lambda-xmu'],
                    distractionFreeMode: true,
                    id: md5(location.pathname),
                    });
                    gitalk.render('gitalk-container');
                </script>
                
                <!-- Gitalk end -->

                

            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#Data Competition" title="Data Competition" rel="2">
                                    Data Competition
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="https://github.com/drop-out">drop-out</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        // BY Fix:去除标题前的‘#’ issues:<https://github.com/qiubaiying/qiubaiying.github.io/issues/137>
        // anchors.options = {
        //   visible: 'always',
        //   placement: 'right',
        //   icon: '#'
        // };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <!-- add jianshu add target = "_blank" to <a> by BY -->
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/eureka-42-21">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/lambda-xmu">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; lambda 2019
                    <br>
                    Theme on <a href="https://github.com/lambda-xmu/lambda-xmu.github.io.git">GitHub</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=lambda-xmu&repo=lambda-xmu.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script type="text/javascript">
    if(navigator.serviceWorker){
        // For security reasons, a service worker can only control the pages that are in the same directory level or below it. That's why we put sw.js at ROOT level.
        navigator.serviceWorker
            .register('/sw.js')
            .then((registration) => {console.log('Service Worker Registered. ', registration)})
            .catch((error) => {console.log('ServiceWorker registration failed: ', error)})
    }
</script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/ 
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers   
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-145892110-1';
    var _gaDomain = 'lambda-xmu.club';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'd4944c30a9161ff9830632d01557244e';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="/img/apple-touch-icon.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
